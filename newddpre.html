
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>DD Presentations</title>
  <link rel="icon" href="https://raw.githubusercontent.com/dhirajdhar/DD-Coolkid-GUI/refs/heads/main/ddpresentations.png" type="image/x-icon">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.0/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pptx-parser/1.0.0/pptx-parser.min.js"></script>
<link rel="icon" href="https://raw.githubusercontent.com/dhirajdhar/DD-Coolkid-GUI/refs/heads/main/ddpresentations.png" type="image/png">
<link rel="apple-touch-icon" href="https://raw.githubusercontent.com/dhirajdhar/DD-Coolkid-GUI/refs/heads/main/ddpresentations.png">
  <style>
    body { margin: 0; background: #cdc2d1; color: #000; font-family: 'Segoe UI', sans-serif; }
    #toolbar { background: #cdc2d1; padding: 10px; display: flex; gap: 10px; flex-wrap: wrap; }
    #canvas {
  position: relative;
  width: 1280px;
  height: 720px;
  margin: auto;
  background: #eee;
  overflow: hidden;
  border: 2px solid #999;
}

/* Only when presenting */
#canvas.presenting-canvas {
  position: absolute;
  top: 50%;
  left: 50%;
  transform-origin: center center;
}
    .slide { position: absolute; width: 100%; height: 100%; background: #fff; display: none; }
    .element { position: absolute; cursor: move; }
    .text-box { padding: 5px; border: 1px dashed #555; }
    input[type="color"], input[type="number"] { width: 60px; }
    .image-wrapper { border: 1px dashed #555; }
.resize-handle { cursor: nwse-resize; }
.resize-handle.nw { cursor: nw-resize; }
.resize-handle.ne { cursor: ne-resize; }
.resize-handle.sw { cursor: sw-resize; }
.resize-handle.se { cursor: se-resize; }
body.presenting .text-box {
  border: none !important;
  pointer-events: none; /* disables editing/dragging */
}

body.presenting .resize-handle {
  display: none !important;
}
button {cursor: pointer;}
/* Fade */
.fade-in { animation: fadeIn 0.8s forwards; }
.fade-out { animation: fadeOut 0.8s forwards; }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }

/* Slide */
.slide-in { animation: slideIn 0.8s forwards; }
.slide-out { animation: slideOut 0.8s forwards; }
@keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
@keyframes slideOut { from { transform: translateX(0); } to { transform: translateX(-100%); } }

/* Zoom */
.zoom-in { animation: zoomIn 0.8s forwards; }
.zoom-out { animation: zoomOut 0.8s forwards; }
@keyframes zoomIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
@keyframes zoomOut { from { transform: scale(1); opacity: 1; } to { transform: scale(0.5); opacity: 0; } }

/* Wipe */
.wipe-in { animation: wipeIn 0.8s forwards; }
.wipe-out { animation: wipeOut 0.8s forwards; }
@keyframes wipeIn { from { clip-path: inset(0 100% 0 0); } to { clip-path: inset(0 0 0 0); } }
@keyframes wipeOut { from { clip-path: inset(0 0 0 0); } to { clip-path: inset(0 0 0 100%); } }

/* Flip */
.flip-in { animation: flipIn 0.8s forwards; transform-origin: center; }
.flip-out { animation: flipOut 0.8s forwards; transform-origin: center; }
@keyframes flipIn { from { transform: rotateY(90deg); opacity:0; } to { transform: rotateY(0); opacity:1; } }
@keyframes flipOut { from { transform: rotateY(0); opacity:1; } to { transform: rotateY(-90deg); opacity:0; } }

/* Rotate */
.rotate-in { animation: rotateIn 0.8s forwards; }
.rotate-out { animation: rotateOut 0.8s forwards; }
@keyframes rotateIn { from { transform: rotate(-180deg); opacity:0; } to { transform: rotate(0); opacity:1; } }
@keyframes rotateOut { from { transform: rotate(0); opacity:1; } to { transform: rotate(180deg); opacity:0; } }

/* Bounce */
.bounce-in { animation: bounceIn 0.8s forwards; }
@keyframes bounceIn {
  0% { transform: scale(0.3); opacity:0; }
  50% { transform: scale(1.1); opacity:1; }
  70% { transform: scale(0.9); }
  100% { transform: scale(1); }
}

.present { padding:10px; margin:6px 0; background:#ffffff; color:#291038; border:none; font-weight:700; cursor:pointer; border-radius:8px; }
.share { padding:10px; margin:6px 0; background-color: Transparent; color:#ffffff; border:1px solid #e5a0ee; font-weight:700; cursor:pointer; border-radius:8px; }

body.presenting #canvas {
  position: absolute;
  top: 50%;
  left: 50%;
  transform-origin: center center;
  background: #000;
}
body.presenting .resize-handle {
  display: block !important;
}
header { background: linear-gradient(to right, #0099ff, #cc00ff); height:52px; display:flex; align-items:center; gap:12px; padding:0 16px; border-bottom:1px solid var(--border); }
header .spacer { flex:1; }
      body.presenting .image-wrapper { border:none; pointer-events:none; }
body.presenting .resize-handle { display:none; }
body.presenting .element { pointer-events:none; }
/* MORPH ANIMATION OVERLAY */
/* MORPH ANIMATION OVERLAY */
.dd-morph-clone {
  position: fixed;
  margin: 0;
  padding: 0;
  pointer-events: none;
  z-index: 999999;
  transition: 
    left 0.6s ease,
    top 0.6s ease,
    width 0.6s ease,
    height 0.6s ease,
    opacity 0.6s ease,
    transform 0.6s ease;
}

/* Optional: smooth fade for elements that appear/disappear */
.dd-morph-fade-in {
  animation: ddMorphFadeIn 0.6s forwards;
}

.dd-morph-fade-out {
  animation: ddMorphFadeOut 0.6s forwards;
}

@keyframes ddMorphFadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes ddMorphFadeOut {
  from { opacity: 1; }
  to { opacity: 0; }
}

#slideStrip {
  width: 100%;
  height: 120px;
  background: #ddd;
  border-top: 2px solid #aaa;
  display: flex;
  gap: 10px;
  overflow-x: auto;
  padding: 10px;
}

.slide-thumb {
  width: 160px;
  height: 90px;
  background: white;
  border: 2px solid #888;
  cursor: pointer;
  position: relative;
  flex-shrink: 0;
  overflow: hidden;
}

.slide-thumb.active {
  border-color: #4a90e2;
  box-shadow: 0 0 5px #4a90e2;
}
  </style>
</head>
<body>
  <header>
    <img src="https://raw.githubusercontent.com/dhirajdhar/DD-Coolkid-GUI/refs/heads/main/ddpresentations.png" width=40 height=40>
    <span style="color: #ffffff;"><b>DD Presentations</b></span>
    <div class="spacer"></div>
    <button class="share"><span aria-hidden="true" class="NA_Img dkWypw"><svg width="17" height="17" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4.5 11.75V19a.5.5 0 0 0 .5.5h14a.5.5 0 0 0 .5-.5v-7.25a.75.75 0 1 1 1.5 0V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-7.25a.75.75 0 1 1 1.5 0Zm8.323-6.19v9.69a.75.75 0 0 1-1.5 0l-.001-9.69-3.037 3.215a.751.751 0 0 1-1.062-1.06l4.318-4.495a.751.751 0 0 1 1.062 0l4.18 4.495a.749.749 0 1 1-1.06 1.06l-2.9-3.216Z" fill="currentColor" fill-rule="nonzero"></path></svg></span>Share</button>
    <button class="present" onclick="slideshow()"><span aria-hidden="true" class="NA_Img dkWypw"><svg xmlns="http://www.w3.org/2000/svg" width="17" height="17" viewBox="0 0 24 24"><path fill="currentColor" d="M12.75 4H20a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-7.23l3.99 3.7a.75.75 0 0 1-1.02 1.1L12 18.33 8.26 21.8a.75.75 0 1 1-1.02-1.1l4-3.7H4a2 2 0 0 1-2-2V6c0-1.1.9-2 2-2h7.25V2.75a.75.75 0 1 1 1.5 0V4zM4 5.5a.5.5 0 0 0-.5.5v9c0 .28.22.5.5.5h16a.5.5 0 0 0 .5-.5V6a.5.5 0 0 0-.5-.5H4zM10 8l4.5 2.5L10 13V8z"></path></svg></span><b>Present</b></button>
  </header>
  <div id="homeScreen" style="padding:40px; text-align:center;">
  <img src="https://raw.githubusercontent.com/dhirajdhar/DD-Coolkid-GUI/refs/heads/main/ddpresentations.png" width=100 height=100>
  <h1>DD Presentations</h1>
  <p>Select a template to begin</p>

  <button onclick="startBlank()" style="padding:20px; font-size:20px;">Blank Template</button>
  <button onclick="loadDDPRE()" style="padding:20px; font-size:20px;">Open</button>
  <br>
  <button onclick="openTemplate(marbles_template)" style="padding:20px; font-size:20px;"><img width="150" height="100" src="https://cdn.create.microsoft.com/uploadedfiles/uploads/66088285-b0b7-4757-9925-8b5c22c7e35e-northern-lights-black-gradient-blended-multitone-ombre-grain-textured-noise-filmic-chromatic-color%25E2%2580%2591rich-spectral-prismatic-0-1.webp"></button>
  <button onclick="openTemplate(glassy_template)" style="padding:20px; font-size:20px;"><img width="150" height="100" src="https://cdn.create.microsoft.com/catalog-assets/en-us/1ddfefa5-03ef-44f0-b9f8-5e27349af6c5/thumbnails/400/prismatic-polygons-gray-modern-contemporary-sleek-minimal-colorful-bright-vibrant-multicolored-creative-imaginative-expressive-innovative-0-1-300d589eba03.webp"></button>
  <button onclick="openTemplate(school_days_template)" style="padding:20px; font-size:20px;"><img width="150" height="100" src="https://cdn.create.microsoft.com/uploadedfiles/uploads/c221f944-f9a5-455b-9ba8-103df7724557-school-days-gray-cartoon-school-children-fun-playful-classroom-young-youthful-lively-whimsical-shapes-0-1.webp"></button>
  <button onclick="openTemplate(roadmap_template)" style="padding:20px; font-size:20px;"><img width="150" height="100" src="/roadmap.png"></button>
</div>
  <div id="main-editor" style="display: none;">
    <div id="toolbar">
    <b>File Name:</b> <input type="text" id="filename" value="My Presentation.ddpre" />
    <label>Options:</label><select>
      <option>File</option>
      <option>New</option>
      <option>Add Slide</option>
      <option>Share</option>
      <option>üìÇ Open</option>
      <option>Save</option>
      <option>DD Developer Mode</option>
      <option>Delete</option>
      <option>‚Æê Undo</option>
      <option>‚Æë Redo</option>
      <option>‚öô Configurations</option>
      <option>üñ® Print</option>
    </select>
        <label>Morph ID:</label>
<input type="text" id="morphIdInput" placeholder="e.g. title1" style="width:100px;">
<button onclick="applyMorphId()">Set Morph ID</button>
<button onclick="clearMorphId()">Clear Morph ID</button>
    <button onclick="addText()">Add Text</button>
    <button onclick="addImage()">Add Image</button>
    <label>Text Colour:</label><input type="color" id="colorPicker">
    <input type="number" id="fontSize" placeholder="Size" />
    <button onclick="document.execCommand('bold')"><img width=30 height=30 src="https://static.wixstatic.com/media/14115b_d71b5bd142564f92b52343397d812bab~mv2.png"></button>
    <button onclick="document.execCommand('underline')"><img width=30 height=30 src="https://static.wixstatic.com/media/14115b_2f6f3270b6db4362a334ae3b3bfdf6f1~mv2.png"></button>
    <button onclick="document.execCommand('italic')"><img width=30 height=30 src="https://static.wixstatic.com/media/14115b_7dce91c388714224a869d6a6973f8ab1~mv2.png"></button>
    <button onclick="document.execCommand('insertUnorderedList')">Bullets</button>
    <select onchange="document.execCommand('fontSize', false, this.value)">
      <option value="">Text Size</option><option value="120">Title DDPRE</option><option value="1">Tiny</option><option value="2">Small</option>
      <option value="3">Normal</option><option value="4">Large</option><option value="5">Larger</option>
      <option value="6">Huge</option><option value="7">Massive</option>
    </select>
    <select onchange="document.execCommand('foreColor', false, this.value)">
      <option value="">Text Color</option><option value="black">Black</option><option value="red">Red</option>
      <option value="blue">Blue</option><option value="green">Green</option><option value="purple">Purple</option>
    </select>
    <label>Slide Background:</label>
<input type="color" id="bgColorPicker" onchange="setSlideBGColor()">
<button onclick="setSlideBGImage()">Set Background Image</button>
    <select id="fontSelector">
      <option value="Segoe UI">Text Font</option>
      <option value="Segoe UI">DD Services</option>
      <option value="jvgfy7rehtyueg">Placeholder HTML</option>
      <option value="Arial">Arial</option>
      <option value="Courier New">Courier New</option>
      <option value="Helvetica">Helvetica</option>
      <option value="Garamond">Garamond</option>
    </select>
    <label for="transitionSelector">Transition:</label>
<select id="transitionSelector">
  <option value="none">None</option>
  <option value="fade">Fade</option>
  <option value="slide">Slide</option>
  <option value="zoom">Zoom</option>
  <option value="wipe">Wipe</option>
  <option value="flip">Flip</option>
  <option value="rotate">Rotate</option>
  <option value="bounce">Bounce</option>
</select>

    <button onclick="addSlide()">Add Slide</button>
    <button onclick="prevSlide()">‚óÄ Prev</button>
    <button onclick="nextSlide()">Next ‚ñ∂</button>
    <button onclick="deleteSelected()">üóë Delete</button>
    <button onclick="saveDDPRE()">Save</button>
    Configurations:
    <select>
      <option>Dynamic</option>
    </select>
    <button style="padding: 10px 20px; background-color: #e5a0ee; border: none; border-radius: 20px;"><img width=20 height=20 src="https://static.wixstatic.com/media/14115b_4e84c2edd65044c494b4654b8f586796~mv2.png"><b>Share</b></button>
    <input type="file" id="fileLoader" accept=".ddpre,.pptx,.gslides" style="display:none" />
  </div>
    <div style="display:none;">
        <button onclick="prevSlide()">‚óÄ Prev</button>
        <button onclick="nextSlide()">Next ‚ñ∂</button>
        <button>Exit</button>
    </div>
   <div id="slideshowtoolbar" style="display:none;">
        dd_present
    </div>
  <div id="canvas"></div>
  <div id="slideStrip"></div>
  </div>
  <script>
    function emuToPx(emu) {
  // EMU (English Metric Unit) ‚Üí pixels at 96 DPI
  if (!emu) return 0;
  return (parseInt(emu, 10) / 914400) * 96;
}

function parseXml(text) {
  return new DOMParser().parseFromString(text, "application/xml");
}

    let slides = [];
    let currentSlideIndex = null;
    let selectedElement = null;
    let savedRange = null;

function saveSelection() {
  const sel = window.getSelection();
  if (sel.rangeCount > 0) {
    savedRange = sel.getRangeAt(0);
  }
}

function restoreSelection() {
  const sel = window.getSelection();
  if (savedRange) {
    sel.removeAllRanges();
    sel.addRange(savedRange);
  }
}

document.addEventListener("click", e => {
  if (e.target.classList.contains("element")) {
    selectedElement = e.target;
  }
});

function deleteSelected() {
  if (selectedElement) {
    selectedElement.remove();
    selectedElement = null;
  }
}
const colorPicker = document.getElementById("colorPicker");

colorPicker.addEventListener("mousedown", saveSelection); // before opening picker

colorPicker.addEventListener("change", function () {
  restoreSelection(); // restore cursor/selection
  document.execCommand("foreColor", false, this.value);
});

function updateSlideStrip() {
  const strip = document.getElementById("slideStrip");
  strip.innerHTML = "";

  slides.forEach((slide, i) => {
    const thumb = document.createElement("div");
    thumb.className = "slide-thumb";
    if (i === currentSlideIndex) thumb.classList.add("active");

    // Clone slide content into thumbnail
    const clone = slide.cloneNode(true);
    clone.style.transform = "scale(0.12)";
    clone.style.transformOrigin = "top left";
    clone.style.pointerEvents = "none";
    clone.style.position = "absolute";
    clone.style.top = "0";
    clone.style.left = "0";

    thumb.appendChild(clone);

    thumb.onclick = () => showSlide(i);

    strip.appendChild(thumb);
  });
}

    function createSlide() {
      const slide = document.createElement('div');
      slide.className = 'slide';
      document.getElementById('canvas').appendChild(slide);
      return slide;
    }

    function scaleCanvasToFullscreen() {
  const canvas = document.getElementById("canvas");
  const slideW = 1280;
  const slideH = 720;

  const screenW = window.innerWidth;
  const screenH = window.innerHeight;

  const scale = Math.min(screenW / slideW, screenH / slideH);

  canvas.style.transform = `translate(-50%, -50%) scale(${scale})`;
}

function showSlide(index) {
  const transition = document.getElementById("transitionSelector").value;
  const incoming = slides[index];
  const outgoing = currentSlideIndex !== null ? slides[currentSlideIndex] : null;

  // Reset classes
  slides.forEach(s => s.className = "slide");

  if (transition === "none" || outgoing === null) {
    // First load or "None" transition ‚Üí instant switch
    slides.forEach((s, i) => s.style.display = i === index ? "block" : "none");
  } else {
    // Animated switch
    outgoing.style.display = "block";
    outgoing.classList.add(transition + "-out");
    outgoing.addEventListener("animationend", () => {
      outgoing.style.display = "none";
    }, { once: true });

    incoming.style.display = "block";
    incoming.classList.add(transition + "-in");
  }

  currentSlideIndex = index;
}
function setSlideBGColor() {
  slides[currentSlideIndex].style.background = document.getElementById("bgColorPicker").value;
}

function setSlideBGImage() {
  const url = prompt("Background image URL:");
  if (url) {
    slides[currentSlideIndex].style.background = `url('${url}') center/cover`;
  }
}

    function addSlide() {
      const newSlide = createSlide();
      slides.push(newSlide);
      showSlide(slides.length - 1);
      addTitle();
      addSubheading();
    }

    function prevSlide() {
      if (currentSlideIndex > 0) showSlide(currentSlideIndex - 1);
    }

    function nextSlide() {
  if (currentSlideIndex < slides.length - 1) {
    const from = currentSlideIndex;
    const to = currentSlideIndex + 1;

    let didMorph = false;
    if (document.body.classList.contains("presenting")) {
      didMorph = morphBetweenSlides(from, to);
    }

    if (!didMorph) {
      showSlide(to);
    } else {
      currentSlideIndex = to;
    }
  }
}
    function startBlank() {
  document.getElementById("homeScreen").style.display = "none";
  document.getElementById("main-editor").style.display = "block";
}

function startDDTemplate() {
  document.getElementById("homeScreen").style.display = "none";
  document.getElementById("main-editor").style.display = "block";

  addSlide();

  // Title
  const title = document.createElement("div");
  title.className = "element text-box";
  title.contentEditable = true;
  title.innerHTML = "<b>Welcome to DD Presentations</b>";
  title.style.left = "200px";
  title.style.top = "50px";
  title.style.fontSize = "90px";
  makeDraggable(title);
  slides[currentSlideIndex].appendChild(title);

  // Subtitle
  const sub = document.createElement("div");
  sub.className = "element text-box";
  sub.contentEditable = true;
  sub.innerText = "A custom template created by Copilot";
  sub.style.left = "250px";
  sub.style.top = "180px";
  sub.style.fontSize = "40px";
  sub.style.color = "#444";
  makeDraggable(sub);
  slides[currentSlideIndex].appendChild(sub);

  // Image
  const img = document.createElement("img");
  img.src = "https://raw.githubusercontent.com/dhirajdhar/DD-Coolkid-GUI/refs/heads/main/ddpresentations.png";
  img.className = "element";
  img.style.left = "500px";
  img.style.top = "300px";
  img.style.width = "250px";
  makeDraggable(img);
  slides[currentSlideIndex].appendChild(img);
}

    function addText() {
      const div = document.createElement('div');
      div.className = 'element text-box';
      div.contentEditable = true;
      div.innerText = 'New Text';
      div.style.left = '100px';
      div.style.top = '100px';
      div.style.color = document.getElementById('colorPicker').value;
      div.style.fontSize = document.getElementById('fontSize').value + 'px';
      makeDraggable(div);
      makeSelectable(div);
      slides[currentSlideIndex].appendChild(div);
    }

    function addImage() {
  const url = prompt('Image URL:');
  if (!url) return;

  // Wrapper
  const wrapper = document.createElement('div');
  wrapper.className = 'element image-wrapper';
  wrapper.style.left = '100px';
  wrapper.style.top = '100px';
  wrapper.style.width = '200px';
  wrapper.style.height = '150px';
  wrapper.style.position = 'absolute';

  // Image
  const img = document.createElement('img');
  img.src = url;
  img.style.width = '100%';
  img.style.height = '100%';
  img.style.display = 'block';
  wrapper.appendChild(img);

  // Add resize handles
  ['nw','ne','sw','se'].forEach(pos => {
    const handle = document.createElement('div');
    handle.className = 'resize-handle ' + pos;
    handle.style.width = '10px';
    handle.style.height = '10px';
    handle.style.background = '#000';
    handle.style.borderRadius = '50%';
    handle.style.position = 'absolute';
    if (pos.includes('n')) handle.style.top = '-5px';
    if (pos.includes('s')) handle.style.bottom = '-5px';
    if (pos.includes('w')) handle.style.left = '-5px';
    if (pos.includes('e')) handle.style.right = '-5px';

    // Resize logic
    handle.onmousedown = function(e) {
      e.stopPropagation(); // prevent drag
      const startX = e.clientX;
      const startY = e.clientY;
      const startW = wrapper.offsetWidth;
      const startH = wrapper.offsetHeight;
      const startL = wrapper.offsetLeft;
      const startT = wrapper.offsetTop;

      document.onmousemove = function(e) {
        let newW = startW, newH = startH, newL = startL, newT = startT;
        if (pos.includes('e')) newW = startW + (e.clientX - startX);
        if (pos.includes('s')) newH = startH + (e.clientY - startY);
        if (pos.includes('w')) {
          newW = startW - (e.clientX - startX);
          newL = startL + (e.clientX - startX);
        }
        if (pos.includes('n')) {
          newH = startH - (e.clientY - startY);
          newT = startT + (e.clientY - startY);
        }
        wrapper.style.width = newW + 'px';
        wrapper.style.height = newH + 'px';
        wrapper.style.left = newL + 'px';
        wrapper.style.top = newT + 'px';
      };
      document.onmouseup = function() {
        document.onmousemove = null;
        document.onmouseup = null;
      };
    };

    wrapper.appendChild(handle);
  });

  makeDraggable(wrapper);
  makeSelectable(wrapper);
  slides[currentSlideIndex].appendChild(wrapper);
}


    function makeDraggable(el) {
      el.onmousedown = function(e) {
        const offsetX = e.clientX - el.offsetLeft;
        const offsetY = e.clientY - el.offsetTop;
        document.onmousemove = function(e) {
          el.style.left = (e.clientX - offsetX) + 'px';
          el.style.top = (e.clientY - offsetY) + 'px';
        };
        document.onmouseup = function() {
          document.onmousemove = null;
          document.onmouseup = null;
        };
      };
    }

function makeSelectable(el) {
  el.addEventListener("mousedown", function (e) {
    if (document.body.classList.contains("presenting")) return;
    selectedElement = el;
    e.stopPropagation();
  });
}

      function getMorphMap(slideElement) {
  const map = {};
  [...slideElement.children].forEach(el => {
    const id = el.dataset.morphId;
    if (id) map[id] = el;
  });
  return map;
}

document.getElementById("canvas").addEventListener("mousedown", () => {
  selectedElement = null;
});

    function saveDDPRE() {
      const data = slides.map(slide => {
  return {
    background: slide.style.background || "",
    elements: [...slide.children].map(el => ({
      type: el.tagName.toLowerCase(),
      content: el.tagName === 'DIV' ? el.innerHTML : el.src,
      morphId: el.dataset.morphId || null,
      style: {
        left: el.style.left,
        top: el.style.top,
        color: el.style.color,
        fontSize: el.style.fontSize,
        width: el.style.width,
        height: el.style.height,
        fontFamily: el.style.fontFamily,
        zIndex: el.style.zIndex
      }
    }))
  };
});
      const blob = new Blob([JSON.stringify({ slides: data }, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = document.getElementById("filename").value.match(/\.(ddpre)$/i)
        ? document.getElementById("filename").value
        : document.getElementById("filename").value + '.ddpre';
      a.click();
    }
    // templates
    const marbles_template = "marbles";
    const glassy_template = "glassy";
    const school_days_template = "school days";
    const roadmap_template = "roadmap";
    async function openTemplate(template_name) {
      document.getElementById("homeScreen").style.display = "none";
      document.getElementById("main-editor").style.display = "block";
      try {
        const file_template = "/templates/"+template_name+".ddpre";
        const response = await fetch(file_template);
        const text = await response.text();
        const data = JSON.parse(text);
        renderDDPRE(data);
      } catch(err) {
        console.error("oh noo my template notting working very gooding:", err);
        alert("sorry, my website not very gooding, tempating not working");
      }
    }

      function morphBetweenSlides(fromIndex, toIndex) {
  const fromSlide = slides[fromIndex];
  const toSlide = slides[toIndex];
  if (!fromSlide || !toSlide) return false;

  const fromMap = getMorphMap(fromSlide);
  const toMap = getMorphMap(toSlide);

  const sharedIds = Object.keys(fromMap).filter(id => toMap[id]);
  if (sharedIds.length === 0) return false; // nothing to morph

  // Show both slides stacked
  fromSlide.style.display = "block";
  toSlide.style.display = "block";

  sharedIds.forEach(id => {
    const fromEl = fromMap[id];
    const toEl = toMap[id];

    const fromRect = fromEl.getBoundingClientRect();
    const toRect = toEl.getBoundingClientRect();

    // Clone fromEl as an overlay
    const clone = fromEl.cloneNode(true);
    clone.classList.add("dd-morph-clone");

    clone.style.left = fromRect.left + "px";
    clone.style.top = fromRect.top + "px";
    clone.style.width = fromRect.width + "px";
    clone.style.height = fromRect.height + "px";
    clone.style.opacity = 1;

    document.body.appendChild(clone);

    // Hide originals during morph
    fromEl.style.visibility = "hidden";
    toEl.style.visibility = "hidden";

    // Trigger layout, then animate to target
    requestAnimationFrame(() => {
      clone.style.left = toRect.left + "px";
      clone.style.top = toRect.top + "px";
      clone.style.width = toRect.width + "px";
      clone.style.height = toRect.height + "px";
    });

    clone.addEventListener("transitionend", () => {
      document.body.removeChild(clone);
      fromEl.style.visibility = "visible";
      toEl.style.visibility = "visible";
      fromSlide.style.display = "none";
    }, { once: true });
  });

  return true;
}

    function loadDDPRE() {
  const input = document.getElementById('fileLoader');
  input.click();
  input.onchange = function () {
    const file = input.files[0];
    const ext = file.name.split('.').pop().toLowerCase();
    document.getElementById("homeScreen").style.display = "none";
  document.getElementById("main-editor").style.display = "block";
    if (ext === 'ddpre') {
      const reader = new FileReader();
      reader.onload = function (e) {
        const data = JSON.parse(e.target.result);
        renderDDPRE(data);
      };
      reader.readAsText(file);
    } else if (ext === 'pptx') {
  const reader = new FileReader();
  reader.onload = async function (e) {
    const zip = await JSZip.loadAsync(e.target.result);

    // Clear current slides
    document.getElementById('canvas').innerHTML = '';
    slides = [];

    // Get slide files in numeric order: slide1.xml, slide2.xml, ...
    const slideFiles = Object.keys(zip.files)
      .filter(f => f.match(/^ppt\/slides\/slide\d+\.xml$/))
      .sort((a, b) => {
        const na = parseInt(a.match(/slide(\d+)\.xml/)[1], 10);
        const nb = parseInt(b.match(/slide(\d+)\.xml/)[1], 10);
        return na - nb;
      });

    for (const slidePath of slideFiles) {
      const slideXmlText = await zip.files[slidePath].async("text");
      const slideXml = parseXml(slideXmlText);

      const slide = createSlide();
      slides.push(slide);

      // 1) Slide background color (solid fill)
      try {
        const bgNode = slideXml.querySelector("p\\:bg p\\:bgPr a\\:solidFill a\\:srgbClr, bg bgPr solidFill srgbClr");
        if (bgNode && bgNode.getAttribute("val")) {
          const hex = "#" + bgNode.getAttribute("val");
          slide.style.background = hex;
        }
      } catch (err) {
        console.warn("PPTX background parse error", err);
      }

      // 2) Text boxes (p:sp)
      const shapes = slideXml.getElementsByTagNameNS("*", "sp");
      for (let sp of shapes) {
        const textNodes = sp.getElementsByTagNameNS("*", "t");
        if (!textNodes.length) continue;

        // Combine all runs in this shape
        let textContent = "";
        for (let t of textNodes) {
          textContent += t.textContent;
        }

        // Position & size from a:xfrm
        const xfrm = sp.querySelector("a\\:xfrm, xfrm");
        let left = 100, top = 100, width = 400, height = 100;
        if (xfrm) {
          const off = xfrm.querySelector("a\\:off, off");
          const ext = xfrm.querySelector("a\\:ext, ext");
          if (off) {
            left = emuToPx(off.getAttribute("x"));
            top = emuToPx(off.getAttribute("y"));
          }
          if (ext) {
            width = emuToPx(ext.getAttribute("cx"));
            height = emuToPx(ext.getAttribute("cy"));
          }
        }

        // Text properties: font size & color
        let fontSizePx = 32;
        let colorHex = "#000000";

        const rPr = sp.querySelector("a\\:rPr, rPr");
        if (rPr) {
          const sz = rPr.getAttribute("sz"); // 1/100 pt
          if (sz) {
            const points = parseInt(sz, 10) / 100;
            fontSizePx = points * (96 / 72); // pt ‚Üí px at 96 DPI
          }
          const colorNode = rPr.querySelector("a\\:srgbClr, srgbClr");
          if (colorNode && colorNode.getAttribute("val")) {
            colorHex = "#" + colorNode.getAttribute("val");
          }
        }

        const div = document.createElement('div');
        div.className = 'element text-box';
        div.contentEditable = true;
        div.innerText = textContent;
        div.style.left = left + "px";
        div.style.top = top + "px";
        div.style.width = width + "px";
        div.style.height = height + "px";
        div.style.fontSize = fontSizePx + "px";
        div.style.color = colorHex;
        makeDraggable(div);
        slide.appendChild(div);
      }

      // 3) Pictures (p:pic)
      const pics = slideXml.getElementsByTagNameNS("*", "pic");
      if (pics.length) {
        // Relationships file for this slide: ppt/slides/_rels/slideN.xml.rels
        const relsPath = slidePath.replace("slides/slide", "slides/_rels/slide") + ".rels";
        let relsXml = null;
        if (zip.files[relsPath]) {
          const relsText = await zip.files[relsPath].async("text");
          relsXml = parseXml(relsText);
        }

        function getImageTarget(rId) {
          if (!relsXml) return null;
          const rels = relsXml.getElementsByTagName("Relationship");
          for (let r of rels) {
            if (r.getAttribute("Id") === rId) {
              return r.getAttribute("Target"); // e.g. "../media/image1.png"
            }
          }
          return null;
        }

        for (let pic of pics) {
          // Position & size from a:xfrm
          const xfrm = pic.querySelector("a\\:xfrm, xfrm");
          let left = 100, top = 100, width = 200, height = 150;
          if (xfrm) {
            const off = xfrm.querySelector("a\\:off, off");
            const ext = xfrm.querySelector("a\\:ext, ext");
            if (off) {
              left = emuToPx(off.getAttribute("x"));
              top = emuToPx(off.getAttribute("y"));
            }
            if (ext) {
              width = emuToPx(ext.getAttribute("cx"));
              height = emuToPx(ext.getAttribute("cy"));
            }
          }

          // Find the image reference via r:embed
          const blip = pic.querySelector("a\\:blip, blip");
          if (!blip) continue;
          const rId = blip.getAttribute("r:embed") || blip.getAttribute("embed");
          if (!rId) continue;

          const target = getImageTarget(rId);
          if (!target) continue;

          // Resolve path inside ZIP
          let imgPath = target.replace("..", "ppt");
          if (!zip.files[imgPath]) {
            imgPath = "ppt/" + target.replace("../", "");
          }
          if (!zip.files[imgPath]) continue;

          const blob = await zip.files[imgPath].async("blob");
          const url = URL.createObjectURL(blob);

          // Use your existing image wrapper model
          const wrapper = document.createElement('div');
          wrapper.className = 'element image-wrapper';
          wrapper.style.left = left + "px";
          wrapper.style.top = top + "px";
          wrapper.style.width = width + "px";
          wrapper.style.height = height + "px";
          wrapper.style.position = 'absolute';

          const img = document.createElement('img');
          img.src = url;
          img.style.width = "100%";
          img.style.height = "100%";
          img.style.display = "block";
          wrapper.appendChild(img);

          // Add resize handles (same logic as addImage)
          ['nw','ne','sw','se'].forEach(pos => {
            const handle = document.createElement('div');
            handle.className = 'resize-handle ' + pos;
            handle.style.width = '10px';
            handle.style.height = '10px';
            handle.style.background = '#000';
            handle.style.borderRadius = '50%';
            handle.style.position = 'absolute';
            if (pos.includes('n')) handle.style.top = '-5px';
            if (pos.includes('s')) handle.style.bottom = '-5px';
            if (pos.includes('w')) handle.style.left = '-5px';
            if (pos.includes('e')) handle.style.right = '-5px';

            handle.onmousedown = function(ev) {
              ev.stopPropagation();
              const startX = ev.clientX;
              const startY = ev.clientY;
              const startW = wrapper.offsetWidth;
              const startH = wrapper.offsetHeight;
              const startL = wrapper.offsetLeft;
              const startT = wrapper.offsetTop;

              document.onmousemove = function(ev2) {
                let newW = startW, newH = startH, newL = startL, newT = startT;
                if (pos.includes('e')) newW = startW + (ev2.clientX - startX);
                if (pos.includes('s')) newH = startH + (ev2.clientY - startY);
                if (pos.includes('w')) {
                  newW = startW - (ev2.clientX - startX);
                  newL = startL + (ev2.clientX - startX);
                }
                if (pos.includes('n')) {
                  newH = startH - (ev2.clientY - startY);
                  newT = startT + (ev2.clientY - startY);
                }
                wrapper.style.width = newW + 'px';
                wrapper.style.height = newH + 'px';
                wrapper.style.left = newL + 'px';
                wrapper.style.top = newT + 'px';
              };
              document.onmouseup = function() {
                document.onmousemove = null;
                document.onmouseup = null;
              };
            };

            wrapper.appendChild(handle);
          });

          makeDraggable(wrapper);
          slide.appendChild(wrapper);
        }
      }
    }

    showSlide(0);
  };
  reader.readAsArrayBuffer(file);
    } else if (ext === 'gslide') {
      alert("Google Slides files must be imported via Google Drive API. This feature is coming soon.");
    } else {
      alert("Unsupported file format.");
    }
  };
}

      function applyMorphId() {
  if (!selectedElement) {
    alert("Select an element first.");
    return;
  }
  const id = document.getElementById("morphIdInput").value.trim();
  if (!id) {
    alert("Enter a Morph ID.");
    return;
  }
  selectedElement.dataset.morphId = id;
}

function clearMorphId() {
  if (!selectedElement) return;
  delete selectedElement.dataset.morphId;
}


function renderDDPRE(data) {
  document.getElementById('canvas').innerHTML = '';
  slides = [];

  data.slides.forEach(slideData => {
    const slide = createSlide();
    slides.push(slide);

    // Restore background
    slide.style.background = slideData.background || "";

    slideData.elements.forEach(obj => {
      let el;
      if (obj.type === 'div') {
        el = document.createElement('div');
        el.className = 'element text-box';
        el.contentEditable = true;
        el.innerHTML = obj.content;
      } else if (obj.type === 'img') {
        el = document.createElement('img');
        el.className = 'element';
        el.src = obj.content;
      }

      Object.assign(el.style, obj.style);
      if (obj.morphId) {
  el.dataset.morphId = obj.morphId;
}
makeDraggable(el);
makeSelectable(el);
      slide.appendChild(el);
    });
  });

  showSlide(0);
}

    function addTitle() {
      const div = document.createElement('div');
      div.className = 'element text-box';
      div.contentEditable = true;
      div.innerHTML = '<b>Title here!</b>';
      div.style.left = '345px';
      div.style.top = '3px';
      div.style.color = 'rgb(0, 0, 0)';
      div.style.fontSize = '120px';
      makeDraggable(div);
      slides[currentSlideIndex].appendChild(div);
    }

    function addSubheading() {
      const div = document.createElement('div');
      div.className = 'element text-box';
      div.contentEditable = true;
      div.innerText = 'Your subheading here!';
      div.style.left = '360px';
      div.style.top = '155px';
      div.style.color = 'rgb(70, 70, 70)';
      div.style.fontSize = '50px';
      makeDraggable(div);
      slides[currentSlideIndex].appendChild(div);
    }

    function slideshow() {
  hardResetCanvas(); // <-- NEW

  document.body.classList.add("presenting");
  document.getElementById('toolbar').style.display = "none";
  document.getElementById('slideStrip').style.display = "none";

  const el = document.documentElement;
  if (el.requestFullscreen) el.requestFullscreen();

  scaleCanvasToFullscreen();
  window.onresize = scaleCanvasToFullscreen;
}

function stopslideshow() {
  document.body.classList.remove("presenting");
  document.getElementById('toolbar').style.display = "block";
  document.getElementById('slideStrip').style.display = "block";

  window.onresize = null;

  hardResetCanvas(); // <-- NEW
}

function resetCanvasPosition() {
  const canvas = document.getElementById("canvas");

  canvas.style.position = "relative";
  canvas.style.transform = "none";
  canvas.style.transformOrigin = "center center";
  canvas.style.margin = "auto";

  // IMPORTANT: clear these, don't set them to "0"
  canvas.style.top = "";
  canvas.style.left = "";
}
// Listen for fullscreen exit events
function hardResetCanvas() {
  const canvas = document.getElementById("canvas");

  // Remove ALL inline styles that affect layout
  canvas.style.position = "";
  canvas.style.top = "";
  canvas.style.left = "";
  canvas.style.transform = "";
  canvas.style.transformOrigin = "";
  canvas.style.margin = "";
}

function exitFullscreenFix() {
  if (!document.fullscreenElement &&
      !document.webkitFullscreenElement &&
      !document.mozFullScreenElement &&
      !document.msFullscreenElement) {

    stopslideshow();
  }
}

document.addEventListener("fullscreenchange", exitFullscreenFix);
document.addEventListener("webkitfullscreenchange", exitFullscreenFix);
document.addEventListener("mozfullscreenchange", exitFullscreenFix);
document.addEventListener("MSFullscreenChange", exitFullscreenFix);

function changeTextSize(size) {
      if (size) {
        document.execCommand("fontSize", false, size);
      }
    }
    document.getElementById("fontSelector").addEventListener("change", function () {
      const selectedFont = this.value;
      document.execCommand("fontName", false, selectedFont);
    });
    document.addEventListener("keydown", e => {
      if (["ArrowLeft"].includes(e.key)) prevSlide();
      if (["ArrowRight"].includes(e.key)) nextSlide();
    });

    // Initialize first slide
    addSlide();
    setInterval(updateSlideStrip, 100);
  </script>
</body>
</html>
